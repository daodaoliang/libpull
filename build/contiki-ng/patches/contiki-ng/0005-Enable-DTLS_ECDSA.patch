From f237b9fa8d6bf1f33d62e0cbe5cd0ded7c7afc57 Mon Sep 17 00:00:00 2001
From: Antonio Langiu <antonio.langiu@studenti.polito.it>
Date: Tue, 19 Dec 2017 11:47:58 +0100
Subject: [PATCH] Enable DTLS ECDSA

---
 os/net/app-layer/coap/coap-dtls.c | 32 +++++++++++++++++++++++++++++---
 os/net/app-layer/coap/coap-dtls.h | 14 ++++++++++++++
 2 files changed, 43 insertions(+), 3 deletions(-)

diff --git a/os/net/app-layer/coap/coap-dtls.c b/os/net/app-layer/coap/coap-dtls.c
index 024e7cabe..69a759eea 100644
--- a/os/net/app-layer/coap/coap-dtls.c
+++ b/os/net/app-layer/coap/coap-dtls.c
@@ -58,6 +58,32 @@ get_psk_info(struct dtls_context_t *ctx, const session_t *session,
 }
 #endif
 /*-----------------------------------------------------------------------------------*/
+#ifdef DTLS_ECC_CONN
+static dtls_ecdsa_data_t* dtls_ecdsa_data;
+static dtls_ecdsa_key_t ecdsa_key;
+void coap_set_ecdsa_data(dtls_ecdsa_data_t* data) {
+    dtls_ecdsa_data = data;
+}
+
+static int get_ecdsa_key(struct dtls_context_t *dtls_context,
+        const session_t *dtls_session,
+        const dtls_ecdsa_key_t **result) {
+    ecdsa_key.priv_key = dtls_ecdsa_data->priv_key;
+    ecdsa_key.pub_key_x = dtls_ecdsa_data->pub_key_x;
+    ecdsa_key.pub_key_y = dtls_ecdsa_data->pub_key_y;
+    *result = &ecdsa_key;
+    return 32;
+}
+
+static int verify_ecdsa_key(struct dtls_context_t *dtls_context,
+        const session_t *dtls_session,
+        const unsigned char *other_pub_x,
+        const unsigned char *other_pub_y,
+        size_t key_size) {
+    return dtls_ecdsa_data->verify_key(key_size, other_pub_x, other_pub_y);
+}
+#endif
+/*-----------------------------------------------------------------------------------*/
 context_t *
 coap_init_communication_layer(uint16_t port)
 {
@@ -68,9 +94,9 @@ coap_init_communication_layer(uint16_t port)
 #ifdef DTLS_PSK
     .get_psk_info = get_psk_info,
 #endif
-#ifdef DTLS_ECC
-    .get_ecdsa_key = NULL,
-    .verify_ecdsa_key = NULL,
+#ifdef DTLS_ECC_CONN
+    .get_ecdsa_key = get_ecdsa_key,
+    .verify_ecdsa_key = verify_ecdsa_key,
 #endif
   };
   context_t * ctx;
diff --git a/os/net/app-layer/coap/coap-dtls.h b/os/net/app-layer/coap/coap-dtls.h
index a45381d9a..95a93dd62 100644
--- a/os/net/app-layer/coap/coap-dtls.h
+++ b/os/net/app-layer/coap/coap-dtls.h
@@ -13,4 +13,18 @@ typedef struct dtls_psk_data_t {
 void coap_set_psk_data(dtls_psk_data_t* data);
 #endif
 
+#ifdef CONN_DTLS_ECDSA
+typedef enum dtls_curve_t {
+    DTLS_CURVE_SECP256R1
+} dtls_curve_t;
+typedef struct dtls_ecdsa_data_t {
+    dtls_curve_t curve;
+    uint8_t* priv_key;
+    uint8_t* pub_key_x;
+    uint8_t* pub_key_y;
+    int (*verify_key) (uint8_t,const uint8_t*,const uint8_t*);
+} dtls_ecdsa_data_t;
+void coap_set_ecdsa_data(dtls_ecdsa_data_t* data);
+#endif
+
 #endif
-- 
2.13.1

